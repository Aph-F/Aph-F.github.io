<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Contrôleur</title>
    <script src="https://cdn.jsdelivr.net/npm/@jaames/iro@5"></script>
</head>
<body>


    <!-- Section de connexion (affichée par défaut) -->
    <div class="connexion" id="connexion-section">
        <button id="connect-btn">Rechercher une appareil</button>
        <p id="status">Statut : En attente de connexion...</p>
    </div>

    <!-- Section de contrôle des couleurs (cachée au départ) -->
    <div id="color-control" style="display: none;">
        <div id="color-picker"></div>
        <button id="send-color-btn">Éclairer</button>
        
    </div>

    <script>
        let port;

        // Fonction de connexion à la barre LED
        async function connectSerial() {
            try {
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 9600 });

                document.getElementById("status").innerText = "Connecté";

                // Masquer la section de connexion et afficher le sélecteur de couleur
                document.getElementById("connexion-section").style.display = "none";
                document.getElementById("color-control").style.display = "block";

                const reader = port.readable.getReader();
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    console.log(new TextDecoder().decode(value));
                }
                reader.releaseLock();
            } catch (error) {
                console.error("Erreur :", error);
                document.getElementById("status").innerText = "Erreur de connexion.";
            }
        }

        // Initialisation de la palette Iro.js
        let colorPicker = new iro.ColorPicker("#color-picker", {
            width: 300,
            layout: [
                { component: iro.ui.Wheel },
                { component: iro.ui.Slider, options: { sliderType: 'value' } }
            ]
        });

        // Mise à jour de l'affichage de la couleur sélectionnée
        colorPicker.on('color:change', function(color) {
            document.getElementById("selected-color").innerText = color.hexString;
        });

        // Fonction pour envoyer la couleur sélectionnée au HC-06
        async function sendColor() {
            if (!port) {
                alert("Aucun appareil connectée !");
                return;
            }

            const rgb = colorPicker.color.rgb;
            const message = `${rgb.r},${rgb.g},${rgb.b}\n`;

            const writer = port.writable.getWriter();
            await writer.write(new TextEncoder().encode(message));
            writer.releaseLock();

            console.log("Couleur envoyée :", message);
        }

        // Associer les événements aux boutons
        document.getElementById("connect-btn").addEventListener("click", connectSerial);
        document.getElementById("send-color-btn").addEventListener("click", sendColor);
    </script>
</body>
</html>
